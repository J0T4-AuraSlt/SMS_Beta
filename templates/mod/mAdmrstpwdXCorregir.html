<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer Contraseña</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Restablecer Contraseña de Usuario</h1>

    <form id="reset-password-form">
        <label for="user-select">Selecciona un usuario:</label>
        <select id="user-select" name="user" required>
            <option value="">-- Selecciona un usuario --</option>
            <!-- Los usuarios se cargarán aquí mediante JavaScript -->
        </select>

        <label for="new-password">Nueva Contraseña:</label>
        <input type="password" id="new-password" name="new_password" required>

        <button type="submit">Restablecer Contraseña</button>
    </form>

    <div id="message"></div>

    <script>
        $(document).ready(function() {
            // Obtener el ID_CLIENTE de la sesión o establecerlo manualmente
            const idCliente = {{ ID_CLIENTE }};

            // Cargar los usuarios en el desplegable
            $.getJSON(`/get_users/${idCliente}`, function(users) {
                users.forEach(function(user) {
                    $('#user-select').append(`<option value="${user.id_usr}">${user.nom_usr} (${user.raz_social})</option>`);
                });
            });

            // Manejo del envío del formulario
            $('#reset-password-form').on('submit', function(e) {
                e.preventDefault(); // Evitar que se envíe el formulario de forma tradicional

                const userId = $('#user-select').val();
                const newPassword = $('#new-password').val();

                $.ajax({
                    url: '/reset_user_password', // Ruta para restablecer la contraseña
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ id_usuario: userId, new_password: newPassword }),
                    success: function(response) {
                        $('#message').text(response.message);
                    },
                    error: function(jqXHR) {
                        $('#message').text(jqXHR.responseJSON.message);
                    }
                });
            });
        });
    </script>
</body>
</html>
